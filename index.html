<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>index</title>
		<meta name="description" content="" />
		<meta name="generator" content="Studio 3 http://aptana.com/" />
		<meta name="author" content="Admissions" />
		<meta name="viewport" content="width=device-width; initial-scale=1.0" />
		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		<link rel="stylesheet" type="text/css" href="css/style.css" media="all" />
		<style>
			label.error{display:block; color:red;}
			
		</style>
		
	</head>
	<body>
	</body>
</html>

<script type="text/javascript" src="mustache.js">//</script>
<script type="text/javascript" src="jquery-1.5.1.min.js">//</script>
<script type="text/javascript" src="underscore.js">//</script>
<script type="text/javascript" src="backbone.js">//</script>


<script type="text/javascript" src="formData.js">//</script>
<script type="text/javascript" src="dataTypes.js">//</script>


<script type="text/javascript">

Template = function ( source ) {
	this.source = source;
	this.template = Handlebars.compile(source);
	
	this.render = function (context) {
	    return ( this.template(context) );
	}
};

TemplateFactory = function(TemplateConstructor, callback){
	this.getTemplate = function(type){
		return (this.templates[type]);
	}
	
	var loadTemplates = function(url, callback, self) {
	    $(document.body).append('<IFRAME id="templates" />');
	    $('iframe#templates').attr('src', url);
	
	    $('iframe#templates').load(function() 
	    {
	        callback(this, self);
	    });
	}
	
	loadTemplates("http://127.0.0.1:8020/Admissions-Application/templates.html", function(iframe, self){
		var templates = new Object();
		$(iframe).contents().find('script[type="text/x-handlebars-template"]').each(function(index){
			var datatype = $(this).attr('title');
			var html = $(this).html();
			templates[datatype] = new TemplateConstructor(html);
		})
		self.templates = templates;
		return( callback() );
	}, this)
};

Navigation = function ( params, templateFactory ){
	this.render = function (){
		this.getTemplate();
		$("body").empty();
		$("body").append(this.currentPage.render());
		$("body").prepend( this.template.render(this) );
	}
	
	this.addPage = function ( params , templateFactory ){
		this.pages[ params.name ] = new formField.Form(params, templateFactory);
		this.order.push( this.pages[ params.name ] );
	}
	
	this.setPage = function ( page ){
		this.currentPage = this.pages[ page ];
		this.render();
	}
	
	this.getTemplate = function(){
		this.template = templateFactory.getTemplate(this.type)
	}
	
	this.pages = new Object();
	this.order = new Array();
	this.type = "navigation";
	
	this.templateFactory = templateFactory;
	
	for( page in params.pages ){
		this.addPage(params.pages[page], templateFactory);
	};
};

AppRouter = Backbone.Router.extend({
    routes: {
        "!/:page": "form",
        "!/:page/:section": "form",
		"*actions": "default"
    },
    form: function( page ){
        navigation.setPage( page );
    },
    "default": function(){
    	router.navigate( "#!/"+navigation.order[0].name, true );
    }
});

function bootstrap(){
	navigation = new Navigation(formValues, templateFactory);
	router = new AppRouter;
	Backbone.history.start();
}

function initialize(){
	templateFactory = new TemplateFactory(Template, bootstrap);
}

initialize();

$("input").live('change', function(){navigation.currentPage.updateValues(); navigation.render();});
</script>